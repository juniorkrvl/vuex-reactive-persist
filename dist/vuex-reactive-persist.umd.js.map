{"version":3,"file":"vuex-reactive-persist.umd.js","sources":["../storage.js","../index.js"],"sourcesContent":["export default class Storage {\n  /**\n   * Creates a new instance of Storage\n   * @param {*Object} options {\n   *    storage: Use custom storage. Must have get/set methods accepting key as parameter.\n   *    reducer: Reduces the value to string,\n   *    parser: Parses the value from string\n   * }\n   */\n  constructor({ storage, reducer, parser }) {\n    this.reducer = reducer || (v => JSON.stringify(v || ''));\n    this.parser = parser || (v => JSON.parse(v || ''));\n    this.previusValue = {};\n    this.watchers = {};\n\n    this.storage = storage || {\n      getItem: key => window.localStorage[key],\n      setItem: (key, val) => (window.localStorage[key] = val)\n    };\n\n    // watch every 1000s\n    setInterval(this._callWatchers, 1000);\n  }\n\n  // Call every watcher that has changed values\n  _callWatchers() {\n    Object.keys(this.watchers).forEach(key => {\n      if (this.previusValue[key] !== this.storage.getItem(key)) {\n        this.watchers[key].forEach(f => f());\n      }\n    });\n  }\n\n  /**\n   * Gets a value from local-storage by key\n   * @param {*String} key Key name\n   * @param {*Any} def Default value\n   */\n  get(key) {\n    console.log('>>>', key, this.storage.getItem(key));\n    const val = this.parser(this.storage.getItem(key));\n    this.previusValue[key] = val || this.previusValue[key];\n    return this.previusValue[key];\n  }\n\n  /**\n   * Sets a value to local storage\n   * @param {*String} key Key name\n   * @param {*Any} val Value to store\n   */\n  set(key, val) {\n    this.previusValue[key] = this.reducer(val);\n    this.storage.setItem(key, this.previusValue[key]);\n  }\n\n  /**\n   * Adds watcher for value change of a key\n   * @param {*String} key\n   * @param {*Function} callback\n   */\n  on(key, callback) {\n    if (callback && callback instanceof Function) {\n      this.watchers[key] = this.watchers[key] || []\n      this.watchers[key].push(callback);\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * Removes a watcher\n   * @param {*String} key\n   * @param {*Function} callback\n   */\n  off(key, callback) {\n    const index = this.watchers[key].indexOf(callback);\n    if (index < 0) return false;\n    this.watchers.splice(index, 1);\n    return true;\n  }\n}\n","import Storage from './storage';\n\nexport default function(options) {\n  options = options || {};\n  const key = options.key || 'vuex';\n  const storage = new Storage(options);\n\n  // filters the mutation type\n  const filter =\n    options.filter ||\n    (type => {\n      return !options.mutations || options.mutations.indexOf(type) >= 0;\n    });\n\n  // replace the current state with new state from storage\n  const replaceState = store => {\n    store.replaceState(Object.assign({}, store.state, storage.get(key)));\n  };\n\n  // find changes between previous and current state and callback watches\n  const invokeWatchers = store => {\n    const prev = storage.get();\n    const paths = options.paths || Object.keys(store.state);\n    return paths.filter(path => {\n      if (prev[path] === store.state[path]) return false;\n      options.watch[path] &&\n        options.watch[path](state[path], prev[path], store);\n      return true;\n    });\n  };\n\n  return function(store) {\n    // restore state\n    replaceState(store);\n    options.initialized && options.initialized(store);\n\n    // watch storage value change\n    storage.on(key, () => {\n      invokeWatchers(store);\n      replaceState(store);\n    });\n\n    store.subscribe(({ type }, state) => {\n      // check if mutation type should be considered\n      if (!filter(type, payload)) return;\n      // find current changes\n      const changes = invokeWatchers(store);\n      // save only on change\n      if (changes.length) {\n        storage.set(options.paths ? pick(state, options.paths) : state);\n      }\n    });\n  };\n}\n\n/**\n * Pick all values specified by te paths and returns an array\n * @param {*Object} object Object to use\n * @param {*Array} paths List of paths to pick\n */\nexport function pick(object, paths) {\n  let list = [];\n  paths.forEach(key => {\n    if (object.hasOwnProperty(key)) {\n      list.push(object[key]);\n    }\n  });\n  return list;\n}\n"],"names":["Storage","ref","storage","parser","reducer","v","JSON","stringify","parse","previusValue","watchers","key","window","localStorage","val","this","_callWatchers","keys","forEach","getItem","f","get","log","set","setItem","on","callback","Function","push","off","index","indexOf","splice","options","const","filter","type","mutations","replaceState","store","Object","assign","state","invokeWatchers","prev","paths","path","watch","initialized","subscribe","object","list","payload","length","hasOwnProperty"],"mappings":"qLAAe,IAAMA,EASnB,SAAYC,OAAEC,YAAkBC,gBACzBC,4BAAsBC,UAAKC,KAAKC,UAAUF,GAAK,UAC/CF,OAASA,YAAWE,UAAKC,KAAKE,MAAMH,GAAK,UACzCI,qBACAC,iBAEAR,QAAUA,qBACJS,UAAOC,OAAOC,aAAaF,qBAC1BA,EAAKG,UAASF,OAAOC,aAAaF,GAAOG,gBAIzCC,KAAKC,cAAe,yBAIlCA,2CACSC,KAAKF,KAAKL,UAAUQ,iBAAQP,GAC7BI,EAAKN,aAAaE,KAASI,EAAKb,QAAQiB,QAAQR,MAC7CD,SAASC,GAAKO,iBAAQE,UAAKA,qBAUtCC,aAAIV,WACMW,IAAI,MAAOX,EAAKI,KAAKb,QAAQiB,QAAQR,QACvCG,EAAMC,KAAKZ,OAAOY,KAAKb,QAAQiB,QAAQR,gBACxCF,aAAaE,GAAOG,GAAOC,KAAKN,aAAaE,GAC3CI,KAAKN,aAAaE,gBAQ3BY,aAAIZ,EAAKG,QACFL,aAAaE,GAAOI,KAAKX,QAAQU,QACjCZ,QAAQsB,QAAQb,EAAKI,KAAKN,aAAaE,iBAQ9Cc,YAAGd,EAAKe,YACFA,GAAYA,aAAoBC,iBAC7BjB,SAASC,GAAOI,KAAKL,SAASC,YAC9BD,SAASC,GAAKiB,KAAKF,IACjB,gBAUXG,aAAIlB,EAAKe,OACDI,EAAQf,KAAKL,SAASC,GAAKoB,QAAQL,WACrCI,EAAQ,UACPpB,SAASsB,OAAOF,EAAO,IACrB,IC5EI,SAASG,GAEtBC,IAAMvB,GADNsB,EAAUA,OACUtB,KAAO,OACrBT,EAAU,IAAIF,EAAQiC,GAGtBE,EACJF,EAAQE,iBACPC,UACSH,EAAQI,WAAaJ,EAAQI,UAAUN,QAAQK,IAAS,GAI9DE,WAAeC,GACnBA,EAAMD,aAAaE,OAAOC,UAAWF,EAAMG,MAAOxC,EAAQmB,IAAIV,MAI1DgC,WAAiBJ,GACrBL,IAAMU,EAAO1C,EAAQmB,MAErB,OADcY,EAAQY,OAASL,OAAOvB,KAAKsB,EAAMG,QACpCP,gBAAOW,GAClB,OAAIF,EAAKE,KAAUP,EAAMG,MAAMI,KAC/Bb,EAAQc,MAAMD,IACZb,EAAQc,MAAMD,GAAMJ,MAAMI,GAAOF,EAAKE,GAAOP,IACxC,MAIX,OAAO,SAASA,GAEdD,EAAaC,GACbN,EAAQe,aAAef,EAAQe,YAAYT,GAG3CrC,EAAQuB,GAAGd,aACTgC,EAAeJ,GACfD,EAAaC,KAGfA,EAAMU,mBAAWhD,EAAUyC,OAkBVQ,EACfC,EAjBKhB,SAAaiB,UAEFT,EAAeJ,GAEnBc,QACVnD,EAAQqB,IAAIU,EAAQY,OAWPK,EAXoBR,EAYnCS,KAZ0ClB,EAAQY,MAahD3B,iBAAQP,GACRuC,EAAOI,eAAe3C,IACxBwC,EAAKvB,KAAKsB,EAAOvC,MAGdwC,GAlBwDT"}