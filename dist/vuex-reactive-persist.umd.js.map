{"version":3,"file":"vuex-reactive-persist.umd.js","sources":["../storage.js","../index.js"],"sourcesContent":["export default class Storage {\n  /**\n   * Creates a new instance of Storage\n   * @param {*Object} options {\n   *    storage: Use custom storage. Must have get/set methods accepting key as parameter.\n   *    reducer: Reduces the value to string,\n   *    parser: Parses the value from string\n   * }\n   */\n  constructor({ storage, reducer, parser }) {\n    this.reducer = reducer || (v => JSON.stringify(v || ''));\n    this.parser = parser || (v => JSON.parse(v || ''));\n    this.previusValue = {};\n    this.watchers = {};\n\n    this.storage = storage || {\n      getItem: key => window.localStorage[key],\n      setItem: (key, val) => (window.localStorage[key] = val)\n    };\n\n    // watch every 1000s\n    setInterval(this._callWatchers, 1000);\n  }\n\n  // Call every watcher that has changed values\n  _callWatchers() {\n    Object.keys(this.watchers).forEach(key => {\n      if (this.previusValue[key] !== this.storage.getItem(key)) {\n        this.watchers[key].forEach(f => f());\n      }\n    });\n  }\n\n  /**\n   * Gets a value from local-storage by key\n   * @param {*String} key Key name\n   * @param {*Any} def Default value\n   */\n  get(key) {\n    try {\n      const val = this.parser(this.storage.getItem(key));\n      this.previusValue[key] = val || this.previusValue[key];\n    } finally {\n      return this.previusValue[key];\n    }\n  }\n\n  /**\n   * Sets a value to local storage\n   * @param {*String} key Key name\n   * @param {*Any} val Value to store\n   */\n  set(key, val) {\n    try {\n      this.previusValue[key] = this.reducer(val);\n      this.storage.setItem(key, this.previusValue[key]);\n    } finally {\n    }\n  }\n\n  /**\n   * Adds watcher for value change of a key\n   * @param {*String} key\n   * @param {*Function} callback\n   */\n  on(key, callback) {\n    if (callback && callback instanceof Function) {\n      this.watchers[key] = this.watchers[key] || [];\n      this.watchers[key].push(callback);\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * Removes a watcher\n   * @param {*String} key\n   * @param {*Function} callback\n   */\n  off(key, callback) {\n    const index = this.watchers[key].indexOf(callback);\n    if (index < 0) return false;\n    this.watchers.splice(index, 1);\n    return true;\n  }\n}\n","import Storage from './storage';\n\nexport default function(options) {\n  options = options || {};\n  const key = options.key || 'vuex';\n  const storage = new Storage(options);\n\n  // filters the mutation type\n  const filter = options.filter || ((type) => {\n    return !options.mutations || options.mutations.indexOf(type) >= 0;\n  });\n\n  // replace the current state with new state from storage\n  const replaceState = store => {\n    const savedState = storage.get(key);\n    if (!savedState) return;\n    store.replaceState(Object.assign({}, store.state, savedState));\n  };\n\n  // find changes between previous and current state and callback watches\n  const invokeWatchers = (store, state) => {\n    let hasChange = false\n    state = state || store.state\n    const prev = storage.get() || {};\n    const paths = options.paths || Object.keys(store.state);\n    paths.forEach(path => {\n      if (prev[path] === state[path]) return;\n      hasChange = true;\n      if (options.watch && options.watch[path]) {\n        options.watch[path](state[path], prev[path], store);\n      }\n    });\n    return hasChange\n  };\n\n  return function(store) {\n    // restore state\n    replaceState(store);\n    options.initialized && options.initialized(store);\n\n    // watch storage value change\n    storage.on(key, () => {\n      invokeWatchers(store);\n      replaceState(store);\n    });\n\n    store.subscribe(({ type, payload }, state) => {\n      // check if mutation type should be considered\n      if (!filter(type, payload)) return;\n      // find current changes\n      const hasChange = invokeWatchers(store, state);\n      // save only on change\n      if (!hasChange) return\n      storage.set(key, options.paths ? pick(state, options.paths) : state);\n    });\n  };\n}\n\n/**\n * Pick all values specified by te paths and returns an array\n * @param {*Object} object Object to use\n * @param {*Array} paths List of paths to pick\n */\nexport function pick(object, paths) {\n  if (!object) return {}\n  let picked = {};\n  paths.forEach(key => {\n    if (object.hasOwnProperty(key)) {\n      picked[key] = object[key]\n    }\n  });\n  return picked;\n}\n"],"names":["Storage","ref","storage","parser","reducer","v","JSON","stringify","parse","previusValue","watchers","key","window","localStorage","val","this","_callWatchers","keys","forEach","getItem","f","get","set","setItem","on","callback","Function","push","off","index","indexOf","splice","options","const","filter","type","mutations","replaceState","store","savedState","Object","assign","state","invokeWatchers","let","hasChange","prev","paths","path","watch","initialized","subscribe","object","picked","hasOwnProperty","pick"],"mappings":"qLAAe,IAAMA,EASnB,SAAYC,OAAEC,YAAkBC,gBACzBC,4BAAsBC,UAAKC,KAAKC,UAAUF,GAAK,UAC/CF,OAASA,YAAWE,UAAKC,KAAKE,MAAMH,GAAK,UACzCI,qBACAC,iBAEAR,QAAUA,qBACJS,UAAOC,OAAOC,aAAaF,qBAC1BA,EAAKG,UAASF,OAAOC,aAAaF,GAAOG,gBAIzCC,KAAKC,cAAe,yBAIlCA,2CACSC,KAAKF,KAAKL,UAAUQ,iBAAQP,GAC7BI,EAAKN,aAAaE,KAASI,EAAKb,QAAQiB,QAAQR,MAC7CD,SAASC,GAAKO,iBAAQE,UAAKA,qBAUtCC,aAAIV,WAEMG,EAAMC,KAAKZ,OAAOY,KAAKb,QAAQiB,QAAQR,SACxCF,aAAaE,GAAOG,GAAOC,KAAKN,aAAaE,kBAE3CI,KAAKN,aAAaE,iBAS7BW,aAAIX,EAAKG,YAEAL,aAAaE,GAAOI,KAAKX,QAAQU,QACjCZ,QAAQqB,QAAQZ,EAAKI,KAAKN,aAAaE,2BAUhDa,YAAGb,EAAKc,YACFA,GAAYA,aAAoBC,iBAC7BhB,SAASC,GAAOI,KAAKL,SAASC,YAC9BD,SAASC,GAAKgB,KAAKF,IACjB,gBAUXG,aAAIjB,EAAKc,OACDI,EAAQd,KAAKL,SAASC,GAAKmB,QAAQL,WACrCI,EAAQ,UACPnB,SAASqB,OAAOF,EAAO,IACrB,ICjFI,SAASG,GAEtBC,IAAMtB,GADNqB,EAAUA,OACUrB,KAAO,OACrBT,EAAU,IAAIF,EAAQgC,GAGtBE,EAASF,EAAQE,iBAAYC,UACzBH,EAAQI,WAAaJ,EAAQI,UAAUN,QAAQK,IAAS,GAI5DE,WAAeC,GACnBL,IAAMM,EAAarC,EAAQmB,IAAIV,GAC1B4B,GACLD,EAAMD,aAAaG,OAAOC,UAAWH,EAAMI,MAAOH,KAI9CI,WAAkBL,EAAOI,GAC7BE,IAAIC,GAAY,EAChBH,EAAQA,GAASJ,EAAMI,MACvBT,IAAMa,EAAO5C,EAAQmB,UASrB,OARcW,EAAQe,OAASP,OAAOvB,KAAKqB,EAAMI,QAC3CxB,iBAAQ8B,GACRF,EAAKE,KAAUN,EAAMM,KACzBH,GAAY,EACRb,EAAQiB,OAASjB,EAAQiB,MAAMD,IACjChB,EAAQiB,MAAMD,GAAMN,EAAMM,GAAOF,EAAKE,GAAOV,MAG1CO,GAGT,OAAO,SAASP,GAEdD,EAAaC,GACbN,EAAQkB,aAAelB,EAAQkB,YAAYZ,GAG3CpC,EAAQsB,GAAGb,aACTgC,EAAeL,GACfD,EAAaC,KAGfA,EAAMa,mBAAWlD,EAAmByC,GAE7BR,qBAEaS,EAAeL,EAAOI,IAGxCxC,EAAQoB,IAAIX,EAAKqB,EAAQe,MAU/B,SAAqBK,EAAQL,GAC3B,IAAKK,EAAQ,SACbR,IAAIS,KAMJ,OALAN,EAAM7B,iBAAQP,GACRyC,EAAOE,eAAe3C,KACxB0C,EAAO1C,GAAOyC,EAAOzC,MAGlB0C,EAlB8BE,CAAKb,EAAOV,EAAQe,OAASL"}