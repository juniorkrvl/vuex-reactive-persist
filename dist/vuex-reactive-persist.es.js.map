{"version":3,"file":"vuex-reactive-persist.es.js","sources":["../storage.js","../index.js"],"sourcesContent":["export default class Storage {\n  /**\n   * Creates a new instance of Storage\n   * @param {*Object} options {\n   *    storage: Use custom storage. Must have get/set methods accepting key as parameter.\n   *    reducer: Reduces the value to string,\n   *    parser: Parses the value from string\n   * }\n   */\n  constructor({ storage, reducer, parser }) {\n    this.reducer = reducer || (v => JSON.stringify(v || ''));\n    this.parser = parser || (v => JSON.parse(v || ''));\n    this.previusValue = {};\n    this.watchers = {};\n\n    this.storage = storage || {\n      getItem: key => window.localStorage[key],\n      setItem: (key, val) => (window.localStorage[key] = val)\n    };\n\n    // watch every 1000s\n    setInterval(this._callWatchers, 1000);\n  }\n\n  // Call every watcher that has changed values\n  _callWatchers() {\n    Object.keys(this.watchers).forEach(key => {\n      if (this.previusValue[key] !== this.storage.getItem(key)) {\n        this.watchers[key].forEach(f => f());\n      }\n    });\n  }\n\n  /**\n   * Gets a value from local-storage by key\n   * @param {*String} key Key name\n   * @param {*Any} def Default value\n   */\n  get(key) {\n    console.log('>>>', key, this.storage.getItem(key));\n    const val = this.parser(this.storage.getItem(key));\n    this.previusValue[key] = val || this.previusValue[key];\n    return this.previusValue[key];\n  }\n\n  /**\n   * Sets a value to local storage\n   * @param {*String} key Key name\n   * @param {*Any} val Value to store\n   */\n  set(key, val) {\n    this.previusValue[key] = this.reducer(val);\n    this.storage.setItem(key, this.previusValue[key]);\n  }\n\n  /**\n   * Adds watcher for value change of a key\n   * @param {*String} key\n   * @param {*Function} callback\n   */\n  on(key, callback) {\n    if (callback && callback instanceof Function) {\n      this.watchers[key] = this.watchers[key] || []\n      this.watchers[key].push(callback);\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * Removes a watcher\n   * @param {*String} key\n   * @param {*Function} callback\n   */\n  off(key, callback) {\n    const index = this.watchers[key].indexOf(callback);\n    if (index < 0) return false;\n    this.watchers.splice(index, 1);\n    return true;\n  }\n}\n","import Storage from './storage';\n\nexport default function(options) {\n  options = options || {};\n  const key = options.key || 'vuex';\n  const storage = new Storage(options);\n\n  // filters the mutation type\n  const filter =\n    options.filter ||\n    (type => {\n      return !options.mutations || options.mutations.indexOf(type) >= 0;\n    });\n\n  // replace the current state with new state from storage\n  const replaceState = store => {\n    store.replaceState(Object.assign({}, store.state, storage.get(key)));\n  };\n\n  // find changes between previous and current state and callback watches\n  const invokeWatchers = store => {\n    const prev = storage.get();\n    const paths = options.paths || Object.keys(store.state);\n    return paths.filter(path => {\n      if (prev[path] === store.state[path]) return false;\n      options.watch[path] &&\n        options.watch[path](state[path], prev[path], store);\n      return true;\n    });\n  };\n\n  return function(store) {\n    // restore state\n    replaceState(store);\n    options.initialized && options.initialized(store);\n\n    // watch storage value change\n    storage.on(key, () => {\n      invokeWatchers(store);\n      replaceState(store);\n    });\n\n    store.subscribe(({ type }, state) => {\n      // check if mutation type should be considered\n      if (!filter(type, payload)) return;\n      // find current changes\n      const changes = invokeWatchers(store);\n      // save only on change\n      if (changes.length) {\n        storage.set(options.paths ? pick(state, options.paths) : state);\n      }\n    });\n  };\n}\n\n/**\n * Pick all values specified by te paths and returns an array\n * @param {*Object} object Object to use\n * @param {*Array} paths List of paths to pick\n */\nexport function pick(object, paths) {\n  let list = [];\n  paths.forEach(key => {\n    if (object.hasOwnProperty(key)) {\n      list.push(object[key]);\n    }\n  });\n  return list;\n}\n"],"names":["Storage","ref","storage","parser","reducer","v","JSON","stringify","parse","previusValue","watchers","key","window","localStorage","val","this","_callWatchers","pick","object","paths","let","list","forEach","hasOwnProperty","push","keys","getItem","f","get","log","set","setItem","on","callback","Function","off","index","indexOf","splice","options","const","filter","type","mutations","replaceState","store","Object","assign","state","invokeWatchers","prev","path","watch","initialized","subscribe","payload","length"],"mappings":"AAAe,IAAMA,EASnB,SAAYC,OAAEC,YAAkBC,gBACzBC,4BAAsBC,UAAKC,KAAKC,UAAUF,GAAK,UAC/CF,OAASA,YAAWE,UAAKC,KAAKE,MAAMH,GAAK,UACzCI,qBACAC,iBAEAR,QAAUA,qBACJS,UAAOC,OAAOC,aAAaF,qBAC1BA,EAAKG,UAASF,OAAOC,aAAaF,GAAOG,gBAIzCC,KAAKC,cAAe,MCuCpC,SAAgBC,EAAKC,EAAQC,GAC3BC,IAAIC,KAMJ,OALAF,EAAMG,iBAAQX,GACRO,EAAOK,eAAeZ,IACxBU,EAAKG,KAAKN,EAAOP,MAGdU,cD1CPL,2CACSS,KAAKV,KAAKL,UAAUY,iBAAQX,GAC7BI,EAAKN,aAAaE,KAASI,EAAKb,QAAQwB,QAAQf,MAC7CD,SAASC,GAAKW,iBAAQK,UAAKA,qBAUtCC,aAAIjB,WACMkB,IAAI,MAAOlB,EAAKI,KAAKb,QAAQwB,QAAQf,QACvCG,EAAMC,KAAKZ,OAAOY,KAAKb,QAAQwB,QAAQf,gBACxCF,aAAaE,GAAOG,GAAOC,KAAKN,aAAaE,GAC3CI,KAAKN,aAAaE,gBAQ3BmB,aAAInB,EAAKG,QACFL,aAAaE,GAAOI,KAAKX,QAAQU,QACjCZ,QAAQ6B,QAAQpB,EAAKI,KAAKN,aAAaE,iBAQ9CqB,YAAGrB,EAAKsB,YACFA,GAAYA,aAAoBC,iBAC7BxB,SAASC,GAAOI,KAAKL,SAASC,YAC9BD,SAASC,GAAKa,KAAKS,IACjB,gBAUXE,aAAIxB,EAAKsB,OACDG,EAAQrB,KAAKL,SAASC,GAAK0B,QAAQJ,WACrCG,EAAQ,UACP1B,SAAS4B,OAAOF,EAAO,IACrB,mBC5EI,SAASG,GAEtBC,IAAM7B,GADN4B,EAAUA,OACU5B,KAAO,OACrBT,EAAU,IAAIF,EAAQuC,GAGtBE,EACJF,EAAQE,iBACPC,UACSH,EAAQI,WAAaJ,EAAQI,UAAUN,QAAQK,IAAS,GAI9DE,WAAeC,GACnBA,EAAMD,aAAaE,OAAOC,UAAWF,EAAMG,MAAO9C,EAAQ0B,IAAIjB,MAI1DsC,WAAiBJ,GACrBL,IAAMU,EAAOhD,EAAQ0B,MAErB,OADcW,EAAQpB,OAAS2B,OAAOrB,KAAKoB,EAAMG,QACpCP,gBAAOU,GAClB,OAAID,EAAKC,KAAUN,EAAMG,MAAMG,KAC/BZ,EAAQa,MAAMD,IACZZ,EAAQa,MAAMD,GAAMH,MAAMG,GAAOD,EAAKC,GAAON,IACxC,MAIX,OAAO,SAASA,GAEdD,EAAaC,GACbN,EAAQc,aAAed,EAAQc,YAAYR,GAG3C3C,EAAQ8B,GAAGrB,aACTsC,EAAeJ,GACfD,EAAaC,KAGfA,EAAMS,mBAAWrD,EAAU+C,GAEpBP,SAAac,UAEFN,EAAeJ,GAEnBW,QACVtD,EAAQ4B,IAAIS,EAAQpB,MAAQF,EAAK+B,EAAOT,EAAQpB,OAAS6B"}