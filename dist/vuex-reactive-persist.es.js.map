{"version":3,"file":"vuex-reactive-persist.es.js","sources":["../storage.js","../index.js"],"sourcesContent":["export default class Storage {\n  /**\n   * Creates a new instance of Storage\n   * @param {*Object} options {\n   *    storage: Use custom storage. Must have get/set methods accepting key as parameter.\n   *    reducer: Reduces the value to string,\n   *    parser: Parses the value from string\n   * }\n   */\n  constructor({ storage, reducer, parser }) {\n    this.reducer = reducer || (v => JSON.stringify(v || ''));\n    this.parser = parser || (v => JSON.parse(v || ''));\n    this.previusValue = {};\n    this.watchers = {};\n\n    this.storage = storage || {\n      getItem: key => window.localStorage[key],\n      setItem: (key, val) => (window.localStorage[key] = val)\n    };\n\n    // watch every 1000s\n    setInterval(this._callWatchers, 1000);\n  }\n\n  // Call every watcher that has changed values\n  _callWatchers() {\n    Object.keys(this.watchers).forEach(key => {\n      if (this.previusValue[key] !== this.storage.getItem(key)) {\n        this.watchers[key].forEach(f => f());\n      }\n    });\n  }\n\n  /**\n   * Gets a value from local-storage by key\n   * @param {*String} key Key name\n   * @param {*Any} def Default value\n   */\n  get(key) {\n    try {\n      const val = this.parser(this.storage.getItem(key));\n      this.previusValue[key] = val || this.previusValue[key];\n    } finally {\n      return this.previusValue[key];\n    }\n  }\n\n  /**\n   * Sets a value to local storage\n   * @param {*String} key Key name\n   * @param {*Any} val Value to store\n   */\n  set(key, val) {\n    try {\n      this.previusValue[key] = this.reducer(val);\n      this.storage.setItem(key, this.previusValue[key]);\n    } finally {\n    }\n  }\n\n  /**\n   * Adds watcher for value change of a key\n   * @param {*String} key\n   * @param {*Function} callback\n   */\n  on(key, callback) {\n    if (callback && callback instanceof Function) {\n      this.watchers[key] = this.watchers[key] || [];\n      this.watchers[key].push(callback);\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * Removes a watcher\n   * @param {*String} key\n   * @param {*Function} callback\n   */\n  off(key, callback) {\n    const index = this.watchers[key].indexOf(callback);\n    if (index < 0) return false;\n    this.watchers.splice(index, 1);\n    return true;\n  }\n}\n","import Storage from './storage';\n\nexport default function(options) {\n  options = options || {};\n  const key = options.key || 'vuex';\n  const storage = new Storage(options);\n\n  // filters the mutation type\n  const filter = options.filter || ((type) => {\n    return !options.mutations || options.mutations.indexOf(type) >= 0;\n  });\n\n  // replace the current state with new state from storage\n  const replaceState = store => {\n    const savedState = storage.get(key);\n    if (!savedState) return;\n    store.replaceState(Object.assign({}, store.state, savedState));\n  };\n\n  // find changes between previous and current state and callback watches\n  const invokeWatchers = (store, state) => {\n    let hasChange = false\n    state = state || store.state\n    const prev = storage.get() || {};\n    const paths = options.paths || Object.keys(store.state);\n    paths.forEach(path => {\n      if (prev[path] === state[path]) return;\n      hasChange = true;\n      if (options.watch && options.watch[path]) {\n        options.watch[path](state[path], prev[path], store);\n      }\n    });\n    return hasChange\n  };\n\n  return function(store) {\n    // restore state\n    replaceState(store);\n    options.initialized && options.initialized(store);\n\n    // watch storage value change\n    storage.on(key, () => {\n      invokeWatchers(store);\n      replaceState(store);\n    });\n\n    store.subscribe(({ type, payload }, state) => {\n      // check if mutation type should be considered\n      if (!filter(type, payload)) return;\n      // find current changes\n      const hasChange = invokeWatchers(store, state);\n      // save only on change\n      if (!hasChange) return\n      storage.set(key, options.paths ? pick(state, options.paths) : state);\n    });\n  };\n}\n\n/**\n * Pick all values specified by te paths and returns an array\n * @param {*Object} object Object to use\n * @param {*Array} paths List of paths to pick\n */\nexport function pick(object, paths) {\n  if (!object) return {}\n  let picked = {};\n  paths.forEach(key => {\n    if (object.hasOwnProperty(key)) {\n      picked[key] = object[key]\n    }\n  });\n  return picked;\n}\n"],"names":["Storage","ref","storage","parser","reducer","v","JSON","stringify","parse","previusValue","watchers","key","window","localStorage","val","this","_callWatchers","pick","object","paths","let","picked","forEach","hasOwnProperty","keys","getItem","f","get","set","setItem","on","callback","Function","push","off","index","indexOf","splice","options","const","filter","type","mutations","replaceState","store","savedState","Object","assign","state","invokeWatchers","hasChange","prev","path","watch","initialized","subscribe"],"mappings":"AAAe,IAAMA,EASnB,SAAYC,OAAEC,YAAkBC,gBACzBC,4BAAsBC,UAAKC,KAAKC,UAAUF,GAAK,UAC/CF,OAASA,YAAWE,UAAKC,KAAKE,MAAMH,GAAK,UACzCI,qBACAC,iBAEAR,QAAUA,qBACJS,UAAOC,OAAOC,aAAaF,qBAC1BA,EAAKG,UAASF,OAAOC,aAAaF,GAAOG,gBAIzCC,KAAKC,cAAe,MC0CpC,SAAgBC,EAAKC,EAAQC,GAC3B,IAAKD,EAAQ,SACbE,IAAIC,KAMJ,OALAF,EAAMG,iBAAQX,GACRO,EAAOK,eAAeZ,KACxBU,EAAOV,GAAOO,EAAOP,MAGlBU,cD9CPL,2CACSQ,KAAKT,KAAKL,UAAUY,iBAAQX,GAC7BI,EAAKN,aAAaE,KAASI,EAAKb,QAAQuB,QAAQd,MAC7CD,SAASC,GAAKW,iBAAQI,UAAKA,qBAUtCC,aAAIhB,WAEMG,EAAMC,KAAKZ,OAAOY,KAAKb,QAAQuB,QAAQd,SACxCF,aAAaE,GAAOG,GAAOC,KAAKN,aAAaE,kBAE3CI,KAAKN,aAAaE,iBAS7BiB,aAAIjB,EAAKG,YAEAL,aAAaE,GAAOI,KAAKX,QAAQU,QACjCZ,QAAQ2B,QAAQlB,EAAKI,KAAKN,aAAaE,2BAUhDmB,YAAGnB,EAAKoB,YACFA,GAAYA,aAAoBC,iBAC7BtB,SAASC,GAAOI,KAAKL,SAASC,YAC9BD,SAASC,GAAKsB,KAAKF,IACjB,gBAUXG,aAAIvB,EAAKoB,OACDI,EAAQpB,KAAKL,SAASC,GAAKyB,QAAQL,WACrCI,EAAQ,UACPzB,SAAS2B,OAAOF,EAAO,IACrB,mBCjFI,SAASG,GAEtBC,IAAM5B,GADN2B,EAAUA,OACU3B,KAAO,OACrBT,EAAU,IAAIF,EAAQsC,GAGtBE,EAASF,EAAQE,iBAAYC,UACzBH,EAAQI,WAAaJ,EAAQI,UAAUN,QAAQK,IAAS,GAI5DE,WAAeC,GACnBL,IAAMM,EAAa3C,EAAQyB,IAAIhB,GAC1BkC,GACLD,EAAMD,aAAaG,OAAOC,UAAWH,EAAMI,MAAOH,KAI9CI,WAAkBL,EAAOI,GAC7B5B,IAAI8B,GAAY,EAChBF,EAAQA,GAASJ,EAAMI,MACvBT,IAAMY,EAAOjD,EAAQyB,UASrB,OARcW,EAAQnB,OAAS2B,OAAOtB,KAAKoB,EAAMI,QAC3C1B,iBAAQ8B,GACRD,EAAKC,KAAUJ,EAAMI,KACzBF,GAAY,EACRZ,EAAQe,OAASf,EAAQe,MAAMD,IACjCd,EAAQe,MAAMD,GAAMJ,EAAMI,GAAOD,EAAKC,GAAOR,MAG1CM,GAGT,OAAO,SAASN,GAEdD,EAAaC,GACbN,EAAQgB,aAAehB,EAAQgB,YAAYV,GAG3C1C,EAAQ4B,GAAGnB,aACTsC,EAAeL,GACfD,EAAaC,KAGfA,EAAMW,mBAAWtD,EAAmB+C,GAE7BR,qBAEaS,EAAeL,EAAOI,IAGxC9C,EAAQ0B,IAAIjB,EAAK2B,EAAQnB,MAAQF,EAAK+B,EAAOV,EAAQnB,OAAS6B"}