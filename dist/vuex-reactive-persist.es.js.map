{"version":3,"file":"vuex-reactive-persist.es.js","sources":["../storage.js","../index.js"],"sourcesContent":["export default class Storage {\n  /**\n   * Creates a new instance of Storage\n   * @param {*Object} options {\n   *    storage: Use custom storage. Must have get/set methods accepting key as parameter.\n   *    reducer: Reduces the value to string,\n   *    parser: Parses the value from string\n   * }\n   */\n  constructor({ storage, reducer, parser }) {\n    this.reducer = reducer || (v => JSON.stringify(v));\n    this.parser = parser || (v => JSON.parse(v));\n    this.previusValue = {};\n    this.watchers = {};\n\n    this.storage = this.storage || {\n      getItem: key => window.localStorage[key],\n      setItem: (key, val) => window.localStorage[(key, val)]\n    };\n\n    // watch every 1000s\n    setInterval(this._callWatchers, 1000);\n  }\n\n  // Call every watcher that has changed values\n  _callWatchers() {\n    Object.keys(this.watchers).forEach(key => {\n      if (this.previusValue[key] !== this.storage.getItem(key)) {\n        this.watchers[key].forEach(f => f());\n      }\n    });\n  }\n\n  /**\n   * Gets a value from local-storage by key\n   * @param {*String} key Key name\n   * @param {*Any} def Default value\n   */\n  get(key) {\n    const val = this.parser(this.storage.getItem(key));\n    this.previusValue[key] = val || this.previusValue[key];\n    return this.previusValue[key];\n  }\n\n  /**\n   * Sets a value to local storage\n   * @param {*String} key Key name\n   * @param {*Any} val Value to store\n   */\n  set(key, val) {\n    this.previusValue[key] = this.reducer(val);\n    this.storage.setItem(key, this.previusValue[key]);\n  }\n\n  /**\n   * Adds watcher for value change of a key\n   * @param {*String} key\n   * @param {*Function} callback\n   */\n  on(key, callback) {\n    if (callback && callback instanceof Function) {\n      this.watchers[key].push(callback);\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * Removes a watcher\n   * @param {*String} key\n   * @param {*Function} callback\n   */\n  off(key, callback) {\n    const index = this.watchers[key].indexOf(callback);\n    if (index < 0) return false;\n    this.watchers.splice(index, 1);\n    return true;\n  }\n}\n","import Storage from './storage';\n\nexport default function(options) {\n  options = options || {};\n  const key = options.key || 'vuex';\n  const storage = new Storage(options);\n\n  // filters the mutation type\n  const filter =\n    options.filter ||\n    (type => {\n      return !options.mutations || options.mutations.indexOf(type) >= 0;\n    });\n\n  // replace the current state with new state from storage\n  const replaceState = store => {\n    store.replaceState(Object.assign({}, store.state, storage.get(key)));\n  };\n\n  // find changes between previous and current state and callback watches\n  const invokeWatchers = store => {\n    const prev = storage.get();\n    const paths = options.paths || Object.keys(store.state);\n    return paths.filter(path => {\n      if (prev[path] === store.state[path]) return false;\n      options.watch[path] &&\n        options.watch[path](state[path], prev[path], store);\n      return true;\n    });\n  };\n\n  return function(store) {\n    // restore state\n    replaceState(store);\n    options.initialized && options.initialized(store);\n\n    // watch storage value change\n    storage.watch(key, () => {\n      invokeWatchers(store);\n      replaceState(store);\n    });\n\n    store.subscribe(({ type }, state) => {\n      // check if mutation type should be considered\n      if (!filter(type, payload)) return;\n      // find current changes\n      const changes = invokeWatchers(store);\n      // save only on change\n      if (changes.length) {\n        storage.set(options.paths ? pick(state, options.paths) : state);\n      }\n    });\n  };\n}\n\n/**\n * Pick all values specified by te paths and returns an array\n * @param {*Object} object Object to use\n * @param {*Array} paths List of paths to pick\n */\nexport function pick(object, paths) {\n  let list = [];\n  paths.forEach(key => {\n    if (object.hasOwnProperty(key)) {\n      list.push(object[key]);\n    }\n  });\n  return list;\n}\n"],"names":["Storage","ref","parser","reducer","v","JSON","stringify","parse","previusValue","watchers","storage","this","key","window","localStorage","val","_callWatchers","pick","object","paths","let","list","forEach","hasOwnProperty","push","keys","getItem","f","get","set","setItem","on","callback","Function","off","index","indexOf","splice","options","const","filter","type","mutations","replaceState","store","Object","assign","state","invokeWatchers","prev","path","watch","initialized","subscribe","payload","length"],"mappings":"AAAe,IAAMA,EASnB,SAAYC,OAAoBC,gBACzBC,4BAAsBC,UAAKC,KAAKC,UAAUF,SAC1CF,OAASA,YAAWE,UAAKC,KAAKE,MAAMH,SACpCI,qBACAC,iBAEAC,QAAUC,KAAKD,2BACTE,UAAOC,OAAOC,aAAaF,qBAC1BA,EAAKG,UAAQF,OAAOC,aAAcC,iBAIlCJ,KAAKK,cAAe,MCuCpC,SAAgBC,EAAKC,EAAQC,GAC3BC,IAAIC,KAMJ,OALAF,EAAMG,iBAAQV,GACRM,EAAOK,eAAeX,IACxBS,EAAKG,KAAKN,EAAON,MAGdS,cD1CPL,2CACSS,KAAKd,KAAKF,UAAUa,iBAAQV,GAC7BD,EAAKH,aAAaI,KAASD,EAAKD,QAAQgB,QAAQd,MAC7CH,SAASG,GAAKU,iBAAQK,UAAKA,qBAUtCC,aAAIhB,OACIG,EAAMJ,KAAKT,OAAOS,KAAKD,QAAQgB,QAAQd,gBACxCJ,aAAaI,GAAOG,GAAOJ,KAAKH,aAAaI,GAC3CD,KAAKH,aAAaI,gBAQ3BiB,aAAIjB,EAAKG,QACFP,aAAaI,GAAOD,KAAKR,QAAQY,QACjCL,QAAQoB,QAAQlB,EAAKD,KAAKH,aAAaI,iBAQ9CmB,YAAGnB,EAAKoB,YACFA,GAAYA,aAAoBC,iBAC7BxB,SAASG,GAAKY,KAAKQ,IACjB,gBAUXE,aAAItB,EAAKoB,OACDG,EAAQxB,KAAKF,SAASG,GAAKwB,QAAQJ,WACrCG,EAAQ,UACP1B,SAAS4B,OAAOF,EAAO,IACrB,mBC1EI,SAASG,GAEtBC,IAAM3B,GADN0B,EAAUA,OACU1B,KAAO,OACrBF,EAAU,IAAIV,EAAQsC,GAGtBE,EACJF,EAAQE,iBACPC,UACSH,EAAQI,WAAaJ,EAAQI,UAAUN,QAAQK,IAAS,GAI9DE,WAAeC,GACnBA,EAAMD,aAAaE,OAAOC,UAAWF,EAAMG,MAAOrC,EAAQkB,IAAIhB,MAI1DoC,WAAiBJ,GACrBL,IAAMU,EAAOvC,EAAQkB,MAErB,OADcU,EAAQnB,OAAS0B,OAAOpB,KAAKmB,EAAMG,QACpCP,gBAAOU,GAClB,OAAID,EAAKC,KAAUN,EAAMG,MAAMG,KAC/BZ,EAAQa,MAAMD,IACZZ,EAAQa,MAAMD,GAAMH,MAAMG,GAAOD,EAAKC,GAAON,IACxC,MAIX,OAAO,SAASA,GAEdD,EAAaC,GACbN,EAAQc,aAAed,EAAQc,YAAYR,GAG3ClC,EAAQyC,MAAMvC,aACZoC,EAAeJ,GACfD,EAAaC,KAGfA,EAAMS,mBAAWpD,EAAU8C,GAEpBP,SAAac,UAEFN,EAAeJ,GAEnBW,QACV7C,EAAQmB,IAAIS,EAAQnB,MAAQF,EAAK8B,EAAOT,EAAQnB,OAAS4B"}